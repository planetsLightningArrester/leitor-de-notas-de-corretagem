# Release workflow
name: 🎁 Create release

# Controls when the workflow will run
on: 
  # Triggers the workflow on push with tags
  push:
    tags:
      - 'v*' # Push events matching v*, i.e. v1.0, v20.15.10

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # Call CI
  ci-check:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  create-release:
    name: 🎁 Create release
    needs: [ci-check]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🚀 Publish release
        id: create_release
        uses: ncipollo/release-action@v1.13.0
        with:
          bodyFile: ./CHANGELOG.md

  upload-artifacts:
    name: 📦 Upload artifacts
    needs: [create-release]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🛠️ NodeJS setup
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: 🔧 Install dependencies
        run:  npm ci

      - name: 📦 Run build
        run:  npm run build

      - name: ⬆️ Upload artifacts
        id: create_release
        uses: ncipollo/release-action@v1.13.0
        with:
          allowUpdates: true
          omitBodyDuringUpdate: true
          omitDraftDuringUpdate: true
          omitNameDuringUpdate: true
          omitPrereleaseDuringUpdate: true
          artifacts: "dist/make/zip/**/*.zip"

# EOF